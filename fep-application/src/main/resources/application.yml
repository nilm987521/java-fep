# FEP System Configuration
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  application:
    name: fep-system
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  # Jackson Configuration
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: Asia/Taipei
    serialization:
      write-dates-as-timestamps: false

# Actuator Endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
  info:
    env:
      enabled: true

# Application Info
info:
  app:
    name: FEP System
    description: Front-End Processor for FISC Interbank Transactions
    version: 1.0.0-SNAPSHOT

# Camunda BPM Configuration
camunda.bpm:
  admin-user:
    id: admin
    password: ${CAMUNDA_ADMIN_PASSWORD:admin}
    first-name: Admin
    last-name: User
  filter:
    create: All tasks
  authorization:
    enabled: false
  history-level: full
  database:
    schema-update: true
  job-execution:
    enabled: true
    max-jobs-per-acquisition: 5
  metrics:
    enabled: true
    db-reporter-activate: false
  webapp:
    index-redirect-enabled: true
  generic-properties:
    properties:
      # History Time To Live (TTL) - required in Camunda 7.22+
      # 保留歷史資料 180 天
      historyTimeToLive: P180D
      # 或者關閉 TTL 強制檢查 (不建議用於生產環境)
      # enforceHistoryTimeToLive: false

# Logging Configuration
logging:
  level:
    root: INFO
    com.fep: DEBUG
    org.springframework.web: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/fep-application.log
    max-size: 100MB
    max-history: 30

# OpenAPI Documentation
springdoc:
  api-docs:
    path: /api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    tags-sorter: alpha
    operations-sorter: alpha

---
# Development Profile
spring:
  config:
    activate:
      on-profile: dev

  # H2 Database for Camunda (Development)
  datasource:
    url: jdbc:h2:mem:camunda;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password:
  h2:
    console:
      enabled: true
      path: /h2-console

# Camunda Dev Settings
camunda.bpm:
  database:
    type: h2
  admin-user:
    password: admin

fep:
  # Dynamic Connection Management
  connection:
    dynamic-management:
      enabled: true                    # 啟用動態連線管理
    config-path: ${CONNECTION_CONFIG_FILE:config/channel-config.json}
    hot-reload-enabled: ${CONNECTION_HOT_RELOAD:false}
    auto-connect: true                 # 開發環境不自動連線
    auto-sign-on: false
    graceful-shutdown-timeout-ms: 5000

  # Channel-Schema Mapping Configuration
  channel:
    enabled: true
    config-file: ${CHANNEL_CONFIG_FILE:config/channel-schema-mapping.json}
    hot-reload: ${CHANNEL_HOT_RELOAD:false}
    hot-reload-interval: 5000
    fail-on-missing-config: false
    validate-schema-references: false

  # FISC Connection Settings (Development)
  fisc:
    # Single-channel mode (legacy)
    host: localhost
    port: 9000
    connection-timeout: 10000
    read-timeout: 30000
    heartbeat-interval: 30000
    max-connections: 5
    auto-reconnect: true

    # Dual-channel mode (FISC standard)
    dual-channel:
      enabled: false  # Set to true to enable dual-channel mode
      send-host: localhost
      send-port: 9001
      receive-host: localhost
      receive-port: 9002
      failure-strategy: FAIL_WHEN_BOTH_DOWN  # FAIL_WHEN_BOTH_DOWN, FAIL_WHEN_ANY_DOWN

  # HSM Settings (Software HSM for Development)
  hsm:
    type: SOFTWARE
    host: localhost
    port: 1500

  # Transaction Settings
  transaction:
    default-timeout: 30000
    max-retry-count: 3
    retry-interval: 1000

  # Rate Limiting
  rate-limit:
    enabled: true
    max-tps: 1000
    algorithm: TOKEN_BUCKET

  # Security
  security:
    pin-block-format: FORMAT_0
    mac-algorithm: ANSI_X9_19

  # BPMN Integration Settings (Development)
  communication:
    server:
      # 訊息處理模式：
      # - default: 使用 DefaultServerMessageHandler (直接轉發到 FISC)
      # - bpmn: 使用 BpmnServerMessageHandler (透過 BPMN 流程處理)
      message-handler: ${MESSAGE_HANDLER_TYPE:default}
    fisc:
      default-channel: FISC_INTERBANK_V1
      timeout-ms: 30000

---
# Production Profile
spring:
  config:
    activate:
      on-profile: prod

  # Oracle Database for Camunda (Production)
  datasource:
    url: ${DATABASE_URL:jdbc:oracle:thin:@localhost:1521:ORCL}
    driver-class-name: oracle.jdbc.OracleDriver
    username: ${DATABASE_USERNAME:fep}
    password: ${DATABASE_PASSWORD:fep}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

# Camunda Production Settings
camunda.bpm:
  database:
    type: oracle
    schema-update: false  # Use Flyway or manual migration in production
  admin-user:
    password: ${CAMUNDA_ADMIN_PASSWORD}
  authorization:
    enabled: true
  job-execution:
    max-jobs-per-acquisition: 10

logging:
  level:
    root: WARN
    com.fep: INFO

fep:
  # Channel-Schema Mapping Configuration (Production)
  channel:
    enabled: true
    config-file: ${CHANNEL_CONFIG_FILE:config/channel-schema-mapping.json}
    hot-reload: ${CHANNEL_HOT_RELOAD:true}
    hot-reload-interval: 10000
    fail-on-missing-config: true
    validate-schema-references: true

  # FISC Connection Settings (Production)
  fisc:
    # Single-channel mode (legacy/fallback)
    host: ${FISC_HOST:192.168.1.100}
    port: ${FISC_PORT:9000}
    connection-timeout: 10000
    read-timeout: 30000
    heartbeat-interval: 30000
    max-connections: 20
    auto-reconnect: true

    # Dual-channel mode (FISC standard - RECOMMENDED for production)
    dual-channel:
      enabled: ${FISC_DUAL_CHANNEL_ENABLED:true}
      send-host: ${FISC_SEND_HOST:192.168.1.100}
      send-port: ${FISC_SEND_PORT:9001}
      send-backup-host: ${FISC_SEND_BACKUP_HOST:192.168.1.101}
      send-backup-port: ${FISC_SEND_BACKUP_PORT:9001}
      receive-host: ${FISC_RECV_HOST:192.168.1.100}
      receive-port: ${FISC_RECV_PORT:9002}
      receive-backup-host: ${FISC_RECV_BACKUP_HOST:192.168.1.101}
      receive-backup-port: ${FISC_RECV_BACKUP_PORT:9002}
      failure-strategy: FAIL_WHEN_BOTH_DOWN
      health-check-interval: 10000

  # HSM Settings (Hardware HSM for Production)
  hsm:
    type: THALES
    host: ${HSM_HOST:192.168.1.200}
    port: ${HSM_PORT:1500}

  # Transaction Settings
  transaction:
    default-timeout: 30000
    max-retry-count: 3
    retry-interval: 1000

  # Rate Limiting
  rate-limit:
    enabled: true
    max-tps: 5000
    algorithm: TOKEN_BUCKET

  # BPMN Integration Settings (Production)
  communication:
    server:
      # 生產環境建議使用 BPMN 模式，確保交易流程可追蹤
      message-handler: ${MESSAGE_HANDLER_TYPE:bpmn}
    fisc:
      default-channel: ${FISC_DEFAULT_CHANNEL:FISC_INTERBANK_V1}
      timeout-ms: ${FISC_TIMEOUT_MS:30000}
